## aurora 전환하기 ##


#### 1. aurora 클러스터 정보를 조회한다 ####

* aws rds describe-db-clusters
```
aws rds describe-db-clusters --query 'DBClusters[].{cluster:DBClusterIdentifier,
    engine:EngineVersion, writer:Endpoint, reader:ReaderEndpoint,
    members:DBClusterMembers}' \
--output table
```
![](https://github.com/gnosia93/database-on-grv/blob/main/tutorial/images/rds-01.png)

#### 2. 2번 노드를 그라비톤으로 전환한다 ####
* https://docs.aws.amazon.com/cli/latest/reference/rds/modify-db-instance.html
```
export TAR_INST_IDENTIFIER=grav-aurora-2
export TAR_INST_CLASS=db.r7g.xlarge

aws rds modify-db-instance --db-instance-identifier ${TAR_INST_IDENTIFIER} \
--db-instance-class ${TAR_INST_CLASS} --apply-immediately \
--no-cli-pager
```

아래 쉘 스크립트를 이용하여 전환 시간을 측정한다. 
```
export TAR_INST_IDENTIFIER=grav-aurora-2
export TAR_INST_CLASS=db.r7g.xlarge

start=`date +%s`
while :
do
   sleep 10
   DB_INST_CLASS=$(aws rds describe-db-instances --query "DBInstances[?DBInstanceIdentifier == '${TAR_INST_IDENTIFIER}'].[DBInstanceClass]" --output text)
   echo "db class conversion in processing from ${DB_INST_CLASS} to ${TAR_INST_CLASS}"

   if [ ${DB_INST_CLASS} = "${TAR_INST_CLASS}" ]        
   then
      echo "db class conversion complted: ${DB_INST_CLASS}"
      break
   fi
done
end=`date +%s`
echo $(($end - $start))" seconds elapsed .."
```


#### 3. 2번 노드를 Writer 로 변경한다 ####
```
export TAR_CLUSTER_IDENTIFIER=grav-aurora-cluster
export TAR_INST_IDENTIFIER=grav-aurora-2

aws rds failover-db-cluster --db-cluster-identifier ${TAR_CLUSTER_IDENTIFIER} \
--target-db-instance-identifier ${TAR_INST_IDENTIFIER} \
--no-cli-pager
```

변경에 소요되는 시간을 측정한다. 

```
export TAR_CLUSTER_IDENTIFIER=grav-aurora-cluster
export TAR_INST_IDENTIFIER=grav-aurora-2


start=`date +%s`
while :
do
   sleep 1
   WRITER_IDENTIFIER=$(aws rds describe-db-clusters | jq '.DBClusters[] | select(.DBClusterIdentifier=="${TAR_CLUSTER_IDENTIFIER}") | .DBClusterMembers[] | select(.IsClusterWriter==true).DBInstanceIdentifier')

   if [ ${WRITER_IDENTIFIER} = "${TAR_INST_IDENTIFIER}" ]        
   then
      break
   fi
done
end=`date +%s`
echo $(($end - $start))" seconds elapsed .."

```




## rds 전환하기 ##
* aws rds describe-db-instances
```
aws rds describe-db-instances --query 'DBInstances[].{id:DBInstanceIdentifier,
    cluster:DBClusterIdentifier, status:DBInstanceStatus, class:DBInstanceClass, 
    address:Endpoint.Address, port:Endpoint.Port, multiAz:MultiAZ,
    version:EngineVersion, az:AvailabilityZone}' \
--output table
```


```
aws rds describe-db-instances --query "DBInstances[?DBInstanceIdentifier == 'grav-aurora-1' && DBInstanceClass == 'db.r7g.xlarge'].[DBInstanceClass]"
```




* aws rds modify-db-instance --db-instance-identifier akash --db-instance-class db.t2.micro --apply-immediately 

## 레퍼런스 ##
* https://docs.aws.amazon.com/cli/latest/reference/rds/modify-db-instance.html
* https://stackoverflow.com/questions/58610529/how-to-make-blocking-aws-cli-calls
* https://www.44bits.io/ko/post/cli_json_processor_jq_basic_syntax
* https://docs.aws.amazon.com/ko_kr/cli/v1/userguide/cli-usage-filter.html
* [Filter, Query 다중 조건 & 대소비교](https://cloudest.oopy.io/posting/058)
* https://www.learnaws.org/2023/08/31/query-multiple-fields-with-aws-cli/
