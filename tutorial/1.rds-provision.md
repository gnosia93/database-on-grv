cdk 이용하여 워크샵용 인프라를 구성한다. 구성 언어로는 타입 스크립트를 사용할 예정이다. 

#### 1. https://nodejs.org/ko/download 로 방문하여 node.js 를 설치한다. ####


#### 2. 설치 버전을 확인한다. ####

```
$ node -v
v22.13.0

$ npm -v
10.9.2
```

#### 3. cdk 를 설치한다. ####
```
$ sudo npm install -g aws-cdk

$ cdk --version
2.175.0 (build 703e81f) 
```

#### 4. cdk 프로젝트를 생성한다. ####
```
$ mkdir grav && cd grav

$ cdk init --language typescript
```

#### 5. 아래와 같이 코드를 수정한다. ####

[bin/grav.ts]
```
#!/usr/bin/env node
import * as cdk from 'aws-cdk-lib';
import { GravStack } from '../lib/grav-stack';

const app = new cdk.App();
new GravStack(app, 'GravStack', {
  env: { account: '<aws-account-number>', region: 'ap-northeast-2' },
});
```
 `<aws-account-number>` 값을 대상 AWS 어카운트로 수정한다. 


[lib/grv-stack.ts]
```
import * as cdk from 'aws-cdk-lib';
import { Construct } from 'constructs';
import * as ec2 from 'aws-cdk-lib/aws-ec2';
import * as rds from 'aws-cdk-lib/aws-rds';
import * as iam from 'aws-cdk-lib/aws-iam';

export class GravStack extends cdk.Stack {
  constructor(scope: Construct, id: string, props?: cdk.StackProps) {
    super(scope, id, props);

    /* https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib.aws_ec2-readme.html */
    const vpc = new ec2.Vpc(this, 'grav-vpc', {
      maxAzs: 3,
      vpcName: 'grav-vpc',
      ipAddresses: ec2.IpAddresses.cidr('10.0.0.0/16'),
      natGateways: 0,      
      enableDnsHostnames: true,
      enableDnsSupport: true, 
      createInternetGateway: true,

      subnetConfiguration: [
        {
          cidrMask: 24,
          name: 'grav-public',
          subnetType: ec2.SubnetType.PUBLIC,
        },
        {
          cidrMask: 24,
          name: 'grav-private',
          subnetType: ec2.SubnetType.PRIVATE_ISOLATED,
        }
      ]
    });


    const ec2SecurityGroup = new ec2.SecurityGroup(this, "grav-ec2-sg", {
      securityGroupName: "grav-ec2-sg", 
      vpc: vpc,
      allowAllOutbound: true,
      description: 'ec2 security group'
    });

    ec2SecurityGroup.addIngressRule(
      ec2.Peer.anyIpv4(),
      ec2.Port.SSH, 
      'allow ssh port inbound from anywhere'
    );

    /* ec2 - 
     * https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib.aws_ec2.Instance.html 
     * https://loige.co/provision-ubuntu-ec2-with-cdk/ 
     * https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib.aws_iam.ManagedPolicy.html
     * simple system manager's role binding - AmazonSSMManagedInstanceCore
     */
    const ec2instance = new ec2.Instance(this, "grav-ec2", {
      vpc: vpc,
      instanceType: ec2.InstanceType.of(ec2.InstanceClass.COMPUTE7_INTEL, ec2.InstanceSize.XLARGE2),
      machineImage: new ec2.AmazonLinuxImage({ generation: ec2.AmazonLinuxGeneration.AMAZON_LINUX_2023 }),
      securityGroup: ec2SecurityGroup,
      associatePublicIpAddress: true,
      instanceName: 'grav-ec2-instance',
      keyPair: ec2.KeyPair.fromKeyPairAttributes(this, 'aws-kp-2', {keyPairName: 'aws-kp-2'}),
      vpcSubnets: { subnetType: ec2.SubnetType.PUBLIC },
      role: new iam.Role(this, 'grav-iam-role', {
        assumedBy: new iam.ServicePrincipal('ec2.amazonaws.com'),
        managedPolicies: [iam.ManagedPolicy.fromAwsManagedPolicyName('AmazonSSMManagedInstanceCore')],
        roleName: 'grav-iam-role'
      })
    });


    /* security group - https://github.com/bobbyhadz/aws-cdk-security-group-example/blob/cdk-v2/lib/cdk-starter-stack.ts */
    const rdsSecurityGroup = new ec2.SecurityGroup(this, "grav-rds-sg", {
      securityGroupName: "grav-rds-sg",  
      vpc: vpc,
      allowAllOutbound: true,
      description: 'database security group'
    });

    rdsSecurityGroup.addIngressRule(
      ec2.Peer.anyIpv4(),
      ec2.Port.MYSQL_AURORA,
      'allow inbound for 3306 port'
    );

    const rdsSubnetGroup = new rds.SubnetGroup(this, 'grav-db-subnet-grp', {
      description: 'grav-db-subnet-grp',
      vpc: vpc,
    
      // the properties below are optional
      removalPolicy: cdk.RemovalPolicy.DESTROY,
      subnetGroupName: 'grav-db-subnet-grp',
      vpcSubnets: {
        onePerAz: true,
        subnetType: ec2.SubnetType.PRIVATE_ISOLATED,
      },
    })



    /* https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib.aws_rds-readme.html */  
    const auroraCluster = new rds.DatabaseCluster(this, 'grav-aurora-cluster', {
      
      clusterIdentifier: "grav-aurora-cluster",
      engine: rds.DatabaseClusterEngine.auroraMysql({ version: rds.AuroraMysqlEngineVersion.VER_3_08_0 }),
      securityGroups: [ rdsSecurityGroup ],
      enablePerformanceInsights: true, 
      
      /* 
       * To delete an RDS instance in AWS CDK without creating a backup, 
       * set the removalPolicy property of your RDS construct to cdk.RemovalPolicy.DESTROY 
       * which explicitly instructs CDK to delete the resource without retaining any backups; 
       * essentially forcing a deletion without considering existing backups. 
       */
      removalPolicy: cdk.RemovalPolicy.DESTROY,
      
      /* https://stackoverflow.com/questions/70974077/is-there-a-way-to-set-the-default-password-while-making-rds-by-cdk */
      credentials: rds.Credentials.fromPassword("admin", cdk.SecretValue.unsafePlainText("mysql-admin")), 
      
      /*
       * db.r6i.xlarge : 4 vCPUs, 32GiB RAM, 10Gbps
       */
      writer: rds.ClusterInstance.provisioned('grav-aurora-1', {
        instanceType: ec2.InstanceType.of(ec2.InstanceClass.R6I, ec2.InstanceSize.XLARGE),
        instanceIdentifier : "grav-aurora-1",
        enablePerformanceInsights: true, 
      }),
      readers: [
        // will be put in promotion tier 1 and will scale with the writer
        rds.ClusterInstance.provisioned('grav-aurora-2', {
          instanceIdentifier: 'grav-aurora-2',
          instanceType: ec2.InstanceType.of(ec2.InstanceClass.R6I, ec2.InstanceSize.XLARGE),
          enablePerformanceInsights: true, 
        }),
        rds.ClusterInstance.provisioned('grav-aurora-3', {
          instanceIdentifier: 'grav-aurora-3',
          instanceType: ec2.InstanceType.of(ec2.InstanceClass.R6I, ec2.InstanceSize.XLARGE),
          enablePerformanceInsights: true, 
        })
      ],
      vpc: vpc,
      subnetGroup: rdsSubnetGroup
    });


    /* https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib.aws_rds.DatabaseInstance.html */
    const mysqlRds = new rds.DatabaseInstance(this, 'grav-mysql-multiAz', {
      engine: rds.DatabaseInstanceEngine.mysql({ version: rds.MysqlEngineVersion.VER_8_4_3 }),
      instanceIdentifier : "grav-mysql-multiAz",
      instanceType: ec2.InstanceType.of(ec2.InstanceClass.R6I, ec2.InstanceSize.XLARGE),
      credentials: rds.Credentials.fromPassword("admin", cdk.SecretValue.unsafePlainText("mysql-admin")), 
      subnetGroup: rdsSubnetGroup,
      vpc: vpc,
      allocatedStorage: 100,
      storageType: rds.StorageType.GP3,
      multiAz: true,
      removalPolicy: cdk.RemovalPolicy.DESTROY,      
      securityGroups: [ rdsSecurityGroup ],
      enablePerformanceInsights: true,   
      backupRetention: cdk.Duration.days(0)
    });


    /*
     * cdk output
     */
    new cdk.CfnOutput(this, 'ec2-public-ip', {
      exportName: 'ec2-public-ip',
      value: ec2instance.instancePublicIp
    })
    new cdk.CfnOutput(this, 'aurora-writer-endpoint', {
      exportName: 'aurora-writer-endpoint',
      value: auroraCluster.clusterEndpoint.hostname 
    })
    new cdk.CfnOutput(this, 'aurora-reader-endpoint', {
      exportName: 'aurora-reader-endpoint',
      value: auroraCluster.clusterReadEndpoint.hostname
    })
    new cdk.CfnOutput(this, 'mysql-endpoint', {
      exportName: 'mysql-endpoint',
      value: mysqlRds.dbInstanceEndpointAddress
    })
  }

}

```

#### 6. 배포하기 ####
```
$ cdk bootstrap

$ cdk deploy --require-approval never
```
![](https://github.com/gnosia93/managed-grav-mig/blob/main/tutorial/images/cdk-02.png)

#### [7. mysql 클라이언트 설치하기](https://docs.aws.amazon.com/ko_kr/AmazonRDS/latest/UserGuide/mysql-install-cli.html) ####
```
$ ssh -i aws-kp-2.pem ec2-user@54.180.232.232

$ sudo dnf install -y mariadb105
$ mysql --version
```
auroa 클러스터의 writer 엔드포인트에 로그인하여 정상 동작 유무를 확인한다. 패스워드는 mysql-admin 이다.
```
$ mysql -h grav-aurora-cluster.cluster-czed7onsq5sy.ap-northeast-2.rds.amazonaws.com -u admin -p
```
![](https://github.com/gnosia93/managed-grav-mig/blob/main/tutorial/images/cdk-01.png)




## 레퍼런스 ##

* https://docs.aws.amazon.com/cdk/v2/guide/getting_started.html
* https://www.typescriptlang.org/docs/handbook/intro.html
* https://ultimatecourses.com/blog/typescript-classes-and-constructors
* https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib-readme.html
* https://blog.mikaeels.com/how-to-use-outputs-in-aws-cdk
